\chapter{Techniques for AP-Reductions}
In this chapter we provide a number of lemmas which can be used for approximated reductions.
First, we show that we can limit the input problem to connected structures. 
Next, we show that reductions is possible when solutions for two problem are related by a 
linear transformation. Next, we introduce a few techniques used for pinning, which is
implementations of unary relations. At the end, we introduce the max-definability, which 
is a strong tool for approximate preserving reductions. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Connected Components
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Connected graphs}
First, we show that by restricting the input to connected structures the complexity of 
\ccsp(\mrelset) does not change. We extend the definition of connectedness from graphs
to general structures.

Let \(\probi = (D, V, \conset)\) be an instance of \ccsp(\mrelset)\@.
Let H(\(\probi\)) be a graph
with the vertex set \mV, and it contains an edge \(\setof{u,v}\) if and only if 
\(u\) and \(v\) appear in the same scope for a constraint in \(\probi\)\@.
We say an instance \(\probi\) is connected if and only if \(H(\probi)\) is connected.
Let \cccsp(\mrelset) denote the problem \ccsp(\mrelset) limited to connected instances.

\begin{lemma} \label{lem:connected}
For any constraint language \mrelset\ the problem \ccsp(\mrelset) is AP-interreducible with
\cccsp(\mrelset)\@.
\end{lemma}

\begin{proof}
The reduction of \cccsp(\mrelset) to \ccsp(\mrelset) is trivial. Now, let \(\probi\) be an instance of
\ccsp(\mrelset), and let \(\probi_1,\dotsc,\probi_r\) be its connected components. Take \(\eps > 0\) 
and set \(\delta = \frac{\eps}{2r}\)\@. Our reduction, given an instance \((\probi,\eps)\) calls
the algorithm for \cccsp(\mrelset) on instances \((\probi_1,\delta), \dotsc,(\probi_r,\delta)\) 
and get outputs \(N = N_1 \dotsm N_r\),
where \(N_i\) is the answer given by the oracle on \((\probi_i,\delta)\)\@.

We claim that the above reduction is an AP-reduction. First of all, observe that it is polynomial
time, and the instances it produces satisfy the conditions of AP-reductions. It remains to show
that if the oracle approximates the solutions with relative error \(\delta\) then the reduction 
provides approximation within \(\eps\)\@.

Since we can assume \(\eps\) is small, we have \((1 - \delta)^r \ge 1 - 2r\delta = 1 - \eps \) and
\( ( 1 + \delta)^r \le 1 + 2r\delta = 1 + \eps\)\@. Now if 
the actual solutions to \(\probi, \probi_1,\dotsc,\probi_r\) are \(N',N_1,\dotsc,N'_r\), then 
we obviously have \(N'=N'_1\dotsm N'_r\)\@. The rest of the proof goes as follows.
\begin{eqnarray*}
&\left|\frac{N'_i - N_i}{N_i}\right| &\le \delta \\
&\left|\frac{N'_i}{N_i} -1 \right| &\le \delta \\
1 - \delta  \le &\frac{N'_i}{N_i} &\le 1 + \delta \\
(1-\delta)^r \le &\frac{N'_1\cdot N'_2 \dotsm N'_r}{N_1\cdot N_2 \dotsm N_r} &\le (1 + \delta)^r \\
1-\eps \le &\frac{N'}{N} &\le 1+\eps \\
&\left|\frac{N'}{N}-1\right|&\le \eps\\
&\left|\frac{N'-N}{N}\right|&\le \eps\\
\end{eqnarray*}
\end{proof}
Hence, in the later proofs we can restrict the input structures to connected structures.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Linear relationship
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Linear Transformations}
Next, we observed that if the answer for any \ccsp(\mrelset) instance and a corresponding
instance of \ccsp(\(\relset'\)) differ by a constant number or a constant factor,
they are AP-interreducible. We generalize this observation to linear transformations. 

\begin{lemma}\label{lem:linear}
Let \(\varphi\) be a polynomial time computable function that maps every instance of a
counting problem \(A\) to an instance of a counting problem problem \(B\) in such a way that
there are constants \(d > 0\) and \(c\) (not necessarily positive) such that
for any \(A\)-instance \(\probi\), we have
\(\#\probi = d\cdot \#\varphi(\probi) + c\)\@. Then if any instance of \(A\)
has at least one solution 
(in case \(c < 0\)), or every instance of \(B\) has at least one solution (in case \(c>0\)), then
there is an AP-reduction from \(A\) to \(B\)\@.
\end{lemma}

\begin{proof}
The AP-reduction works as follows. On an instance \(\probi\) of \(A\) and \(\eps > 0\) it makes 
an oracle call \((\varphi(\probi),\delta)\) to \(B\), where \(\delta = \frac{\eps}{p}\) for 
\(c > 0\), \(p = 1\) otherwise, \(p = \frac1-c/d\) and
if the oracle's reply is \(N\), it returns \(dN + c\)\@. Clearly the algorithm make polynomially 
many steps and oracle calls, and the oracle request is of the correct form.
Thus, it suffices to show that if the oracle's solution is within relative error of \(\delta\) then
the algorithm gives an \(1+\eps\)-approximation of \(\#\probi\)\@.

Let the exact and approximation solutions for \(\varphi(\probi)\) be \(N'\) and \(N\), respectively;
then the exact and approximation solutions for \(\probi\) are  
\(dN' + c\) and \(dN + c\), respectively. Since \(\#probi > 0\), we can 
assume that \(dN+c,dN'+c,N,N'>0\)\@. With the choice of \(p\), it is trivial that
 \(\frac{dN}{dN+c} \le p\)\@. Thus we have \(\frac{dN}{dN+c}\delta \le \eps\).
All we need to show is that if \(\left|\frac{N-N'}{N}\right|<\delta\) holds then
\(\left|\frac{dN-dN'}{dN+c}\right|<\eps\) holds as well.
\begin{eqnarray*}
\frac{dN}{dN+c}\delta & \le & \eps \\
1 + \frac{dN}{dN+c}\delta & \le & 1 + \eps \\
\frac{d N (1+\delta)+c}{d N + c} & \le & \eps \\
\end{eqnarray*}
The inequality \(\eps \le \frac{d N (1-\delta)+c}{d N + c}\) is similar.
Combining these with the assumption that \(1-\delta \le \frac{N'}{N} \le 1 + \delta \),
we get \(1-\eps \le \frac{dN'+c}{dN+c} \le 1 + \eps\). We continue with the proof as:
\begin{eqnarray*}
1-\eps \le \frac{dN'+c}{dN+c} & \le & 1 + \eps \\
\left|1 + \frac{dN' + c}{dN + c}\right| &\le & \eps \\
\left| \frac{dN-dN'}{dN+c}\right| & \le& \eps
\end{eqnarray*}
This completes the proof.
\end{proof}

\begin{lemma}\label{lem:logarithm}
Let \(\varphi\) be a polynomial time computable function that maps every instance of a
counting problem \(A\) to an instance of a counting problem problem \(B\) in such a way that
there is a constant \(m>0\) such that
for any \(A\)-instance \(\probi\) we have
\(\#\probi = (\#\varphi(\probi))^m\)\@.
There is an AP-reduction from \(A\) to \(B\)\@.
\end{lemma}

\begin{proof}
The AP-reduction works as follows: On an instance \(\probi\) of \(A\) and \(\eps > 0\) it makes 
an oracle call \((\varphi(\probi),\delta)\) to \(B\), where \(\delta = \frac{\eps}{m}\) and 
and if the oracle's reply is \(N\), it returns \(N^m\)\@. Clearly the algorithm make polynomially 
many steps and oracle calls, and the oracle request is of the correct form.
Thus, it suffices to show that if the oracle's solution is within relative error of \(\delta\) then
the algorithm gives an \(1+\eps\)-approximation of \(\#\probi\)\@.

Let the exact and approximation solutions for \(\varphi(\probi)\) be \(N'\) and \(N\), respectively;
then the exact and approximation solutions for \(\probi\) are  
\(N'^m\) and \(N^m\), respectively.
All we need to show is that if \(\left|\frac{N-N'}{N}\right|<\delta\) holds then
\(\left|\frac{N^m-N'^m}{N^m}\right|<\eps\) holds as well. Without loss of generality we assume
\(N>N'\).
\begin{eqnarray*}
\frac{|N-N'|}{N} & \le & \delta \\
\frac{N'}{N} & \le & 1 + \delta \\
\frac{N'^m}{N^m} & \le & (1 + \delta) ^ m\\
\frac{N'^m}{N^m} & \le & 1 + m\cdot\delta \\
\frac{N'^m}{N^m} & \le & 1 + \eps \\
\frac{N^m - N'^m}{N^m} & \le & \eps
\end{eqnarray*}
The inequality \(\eps \le \frac{N'^m - N^m}{N^m}\) is similar.
This completes the proof.
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Projection
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Projection}
Let \mR\ be a \(k\)-ary relation and \(S=\setof{i_1,\dotsc,i_l} \subseteq \setof{1,\dotsc,k}\)\@.
By \(\proj S R\) we denote the \emph{projection} of \mR\ onto the set \(S\) of its coordinate
positions, that is, the relation \(\{(a_{i_1},\dotsc,a_{i_l}) \mid (a_1,\dotsc,a_k)\in R\}\)\@.
Observe that \(\proj S R\) is pp-definable in \mR\ by quantifying away all coordinate
positions of \mR\ except for those in \(S\)\@.
Although existential quantification is not known to give rise to AP-reducible problems, in some
cases it does.

\begin{lemma}\label{lem:projection}
Let \mrelset\ be a constraint language over the domain \mD\ and
 let \mR\ be some \(k\)-ary relation in \mrelset\@.
If there is a set \(S\subset D\) such that \(|\proj S R|=|R|\) then 
\ccsp(\(\relset \cup \setof{\proj S R}\)) \maple\ \ccsp(\mrelset)\@.
\end{lemma}

\begin{proof}
The AP-reduction is constructed as follows: Given an instance \(\probi=(D,V,\conset)\)
of \ccsp(\(\relset\cup \{\proj S R\}\)), we define an 
instance \(\probi'=(D,V',\conset')\) of \(\ccsp(\relset)\) with the same number of solutions.
Let \(l=|S|\)\@. \(V'\) includes all the variables of \(V\) and
\(\conset'\) includes all constraints from \mconset\ except for those with \(\proj S R\). For each
constraint \(C=\const{\proj S R,(v_1,\dotsc,v_l)}\) in \mconset\ 
we include a new constraint \(C'=\const{R,(w_1,\dotsc,w_k)}\) in \(\conset'\), where 
\(w_i=v_{i_j}\) if \(i\in S\) and \(i=i_j\), otherwise a fresh variable.

Clearly, the restriction of any solution of \(\probi'\) onto \(V\) is a solution of \(\probi\)\@.
Furthermore, the condition \(|\proj S R|=|R|\) implies that any solution of \(\probi\)
can be extended to a solution of \(\probi'\) in a unique way.
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Pinning
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Pinning}
Theorem \ref{trm:partial} states that if relation \mR\ can be expressed as conjunctions 
of relations from \mrelset, \ccsp(\(\relset \cup \setof R\)) \(\aple\) \ccsp(\mrelset)\@.
The conditions for this theorem, even for parsimonious reductions, are too strict. 
In the rest of this chapter we provide several more lenient conditions.

The ability to tie certain CSP variables to specific values in hardness proofs is 
\emph{pinning}\@. This idea was introduced by Creignou and Hermann \cite{Nadia}. The idea
is also used in many other proofs \cite{bulatov07,Dyer,Trichotomy,madu}. Pinning can be
viewed as showing that for a constraint language \mrelset\ and a set \(S\), 
\ccsp(\(\relset \cup \setof S\)) \(\aple\) \ccsp(\mrelset) holds.

\begin{lemma} [Pinning and reflexive elements] \label{lem:refpin}
Let \mrelset\ be a set of relations on a set \mD, and let for a certain subset \(S \subset D\)
there be a relation \mR\ such that \(x\in S\) if and only if 
\((x,x,\dotsc,x)\in R\)\@. If such a relation \mR\ exists in \mrelset\ then
\ccsp(\(\relset \cup \setof S\)) \maple\ \ccsp(\mrelset)\@.
\end{lemma}

\begin{proof}
\(S\) can be viewed as a unary relation and can be expressed as a predicate 
\(\varphi(x) = R(x,x,\dotsc,x)\)\@. By Theorem~\ref{trm:partial}
\ccsp(\(\relset \cup \setof S\)) \(\aple\) \ccsp(\mrelset)\@.
\end{proof}

Next lemma generalizes the Pinning Lemma from \cite{Trichotomy}.
This lemma allows one to add an extra unary relation to the constraint language. 
The proof of Lemma~\ref{lem:pinning} also follows closely the proof in \cite{Trichotomy}. 

\begin{lemma}[Extended Pinning]\label{lem:pinning}
Let \(\relset\) be a constraint language over the set \mD\ of size \(k\)\@,
and let for a certain subset \(S \subset D\) 
there be an \(l\)-ary relation \(R \in \relset\) and a coordinate position \(j\),
\(1 \le j \le l\), such that for any \(a\in S\) the relation \mR\ has more tuples
\(\vara\) with \(\vara[j]=a\) than tuples \(\varb\) with
\(\varb[j] \notin S\)\@. Then \(\ccsp(\relset \cup \setof{S}) \aple \ccsp(\relset)\)\@.
\end{lemma}

\begin{proof} 
Fix an \(l\)-ary relation \(R \in \relset\)\@, and 
a coordinate position \(j\) such that \mR\ and \(j\) satisfy the conditions of the lemma.
Let also \(w\) be the minimal (over elements \(a\in S\)) number of tuples \(\vara\)
such that \(\vara[j]=a\), and let \(w'\) be the number of tuples \(\varb\) with
\(\vara[j] \notin S\). By the conditions of the lemma \(w'<w\)\@.

Consider an instance \(\probi=(D,V,\conset)\) of \ccsp(\(\relset \cup \setof{S}\))
with \mn\ variables. Let \(N_S\) be the set of
variables which occur in the scope of constraints of \(\conset\) with relation \(S\)\@. 
Set \(n_S = |N_S|\) and \(m = \ceil{\frac{n+2}{\lg{\frac{w}{w'}}}}\)\@.
Construct an instance \(\probi'=(D,V',\conset')\) of \(\ccsp(\relset)\) as follows:
\begin{itemize}
\item
\(V'\) includes all variables from \(V\),
and also, for each variable \(x \in N_S\), any \(u \in \setof{\oneto m}\), and any
\(v\in\setof{0,1,\dotsc,k}-\{j\}\) a fresh variable \(x_{u,v}\)\@. 
\item 
\(\conset'\) includes all constraints from \mconset\ other than those involving \(S\)\@. 
\item
For each constraint \(C=\const{S, (x)}\) from \mconset\ include \mm\ constraints whose
relation is \mR, variable \(x\) occupies the \(j\)th position in the scope,
and the variable \(x_{u,v}\) is in the \(v\)th position of the \(u\)th constraint.
\end{itemize}

Now any solution of \(\probi\) can be extended in at least \(w^{mn_S}\) 
ways to a solutions of \(\probi'\)\@, provided all variables from \(N_S\)
take values from \(S\)\@. On the other hand, every assignment that does not satisfy this
condition can be extended in at most \(w^{m(n_S-1)}w^{\prime m}\) ways.
There exist no more than \(k^n\) such solutions. Therefore if \(N\) and \(N'\)
denote the number of solutions to \(\probi\) and \(\probi'\), respectively, then
\[N\cdot w^{mn_S} \le N' \le Nw^{mn_S} + k^nw^{m(n_s-1)}w'^m.\]
So, for a properly chosen \mm, 
\[N \le \frac{N'}{w^{mn_S}} \le N + \frac{1}{4},\]
By Lemma~\ref{lem:linear} the linear transformations preserve AP-reduction
and this completes the proof.
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Maximization
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Maximization}
This technique is a powerful tool to prove hardness results among many \ccsp\ problems.
We believe this technique may play a role in proving a classification theorem for \ccsp(\mrelset)
problem.

\begin{defi}[Max-definable]\label{def:max}
Let \mrelset\ be a set of relations over the domain \mD,
and \mR\ be an \mn-ary relation over the same domain. 
For any predicate \(\varphi\), define the function
\(f_\varphi\) as \(f_\varphi(x_1,x_2,\dotsc,x_n)=\#\setof{(y_1,y_2,\dotsc,y_k) \mid
\varphi(x_1,x_2,\dotsc,x_n,y_1,y_2,\dotsc,y_k)}\)\@. Also denote the value of
\(\max_{x_1,\dotsc,x_n} f_\varphi(x_1,\dotsc,x_n)\) by \(M_\varphi\)\@.
If there is predicate \(\varphi(x_1,\dotsc,x_n,y_1,\dotsc,y_k)\) 
consisting of conjunctions of relations from \mrelset\ such that
 \(R=\{(x_1,\dotsc,x_n) \mid f_\varphi(x_1,\dotsc,x_n) = M_\varphi\}\) then
relation \mR\ is said to be \emph{max-definable} by \mrelset\@.
\end{defi} 

Given a scope of variables \(\varrho\) and a predicate \(\varphi\) expressed as above definition
\(\varphi\) we can be also viewed as a set of constraints.

\begin{theorem}[Maximization]\label{theo:max}
Let \mrelset\ be a set of relations over the domain \mD,
and \mR\ be an \mn-ary relation on the same domain. 
If \mR\ is max-definable by \mrelset\ then \ccsp(\(\relset \cup \setof R\))~\maple~
\ccsp(\mrelset)\@.
\end{theorem}

\begin{proof}
For any instance \(\probi = (D,V,\conset)\) of  \ccsp(\(\relset \cup \setof R\)) we
construct instance \(\probi' = (D, V',\conset')\) of  \ccsp(\mrelset) by using 
predicate \(\varphi\) and numbers \(M(M_\varphi)\) and \(k\) from Definition~\ref{def:max} as follows:
\begin{itemize}
\item 
Choose sufficiently large integer \mm(to be determined later)
\item
Let \(C_1,\dotsc,C_l\in\conset\) be the constraints with \mR\ where
\(C_i=\const{R,\varrho_i}\)\@. For each \(1\le i \le l\) and for each \(1\le j\le m\), set
\(V^j_i = \{v^j_{i,1},\dotsc,v^j_{i,k}\}\) and \(\conset^j_i\) is a set of constraints
corresponding \(\varphi\) as mentioned before with the scope \(\varrho_{i,1},\dotsc,\varrho_{i,n},
v^j_{i,1},\dotsc,v^j_{i,k}\)\@.
\item Set \(V'=V \cup \bigcup_{j=1}^m \bigcup_{i=1}^l V^j_i\)
\item Set \(\conset' = \conset - \setof{C_1,\dotsc,C_l} \cup 
\bigcup_{j=1}^m \bigcup_{i=1}^l \conset^j_i\)

Now, it is easily seen, every solution of \(\probi\) can be extended to a solution of \(\probi'\)
in \(M^{lm}\) ways. Observe that sometimes the restriction of a solution \(\psi\)
of \(\probi'\) to \(V\) is not a solution of \(\probi\)\@. Indeed, it may happen that
although \(\psi\) satisfies every constraint from \(\conset - \setof{C_1,\dotsc,C_l}\),
its restriction to \(\varrho_i\) does not belong to \mR; however, this restriction does not have
sufficiently many extensions to solutions of \(\probi'\)\@.
On the other hand, any assignment to \(V\) that is not a solution to
\(\probi\) can be extended to a solution of \(\probi\) in at most \((M-1)^m\cdot M^{(l-1)m}\)
ways. Hence, 
\[M^{lm}\cdot \#\probi \le  \#\probi'  
 \le  M^{lm} \cdot \#\probi + |V|^{|D|} \cdot (M-1)^{m} \cdot M ^{(l-1)m}
 \]
The we output \(\lfloor N \rfloor\), where \(N=\#\probi'/M^{lm}\)\@.

We want to choose \mm\ large enough such that the following holds.
\begin{eqnarray*}
|V|^{|D|} \cdot \left(\frac{M-1}{M}\right)^{m} & \le & 1 \\
\log (|V|^{|D|}) + \log\left( \left(1-\frac{1}{M}\right)^{m} \right) & \le &  0 \\
|D| \cdot \log |V| + m \cdot \log \left(1-\frac{1}{M}\right) & \le & 0 \\ 
|D| \cdot \log |V| & \le & m \cdot -\log \left(1-\frac{1}{M}\right) \\ 
\frac{|D| \cdot \log |V|}{-\log \left(1-\frac{1}{M}\right)} & \le & m \\
\end{eqnarray*}
For any \(0<x<1\) we have \(\-log (1-x) > x \); hence, 
\[
\frac{|D| \cdot \log |V|}{-\log \left(1-\frac{1}{M}\right)} \le 
M \cdot |D| \cdot \log |V|
\]
This implies for \(m \ge M \cdot |D| \cdot \log |V|\), we have 
\(\#P=\lfloor N \rfloor\)

\end{itemize}
\end{proof}

As an example of the applications of the theorem consider the following corollary. 
\begin{cor}  \label{cor:degree}
Let \(\relset\) be a constraint language over the set \mD\@,
and let for a certain subset \(S \subset D\) 
there be an \(l\)-ary relation \(R \in \relset\) and a sequence of real numbers
\(a_1,\dotsc ,a_l\) such that for \(x\) in \(S\), sum over dimension of \mR\
the tuples with \(x\) at that row times \(a_i\) is more than same sum for
all elements not in \(S\).
Then \(\ccsp(\relset \cup \setof{S}) \aple \ccsp(\relset)\)\@.
\end{cor}

